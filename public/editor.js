// Generated by CoffeeScript 1.6.3
var appData, displaySaved, e, _canvas;

displaySaved = function(sha, imgData) {
  var n, url;
  if (imgData) {
    url = "data:image/png;base64," + imgData;
  } else {
    n = Math.floor(parseInt(sha.substring(0, 1), 16) / 4);
    url = "http://a" + n + ".pixiecdn.com/" + sha;
  }
  return $.gritter.add({
    title: '',
    text: '',
    image: url,
    time: '',
    sticky: true
  });
};

try {
  if (appData = JSON.parse(localStorage.pixieData)) {
    appData.each(function(datum) {
      return displaySaved(datum);
    });
  } else {
    appData = [];
  }
} catch (_error) {
  e = _error;
  appData = [];
}

_canvas = null;

$(function() {
  var pixelEditor;
  $(document).on("click", ".gritter-item", function() {
    var src;
    src = $(this).find("img").attr("src");
    return _canvas.fromDataURL(src);
  });
  pixelEditor = Pixie.Editor.Pixel.create({
    width: 32,
    height: 32,
    initializer: function(canvas) {
      _canvas = canvas;
      canvas.addAction({
        name: "download",
        perform: function(canvas) {
          var w;
          w = window.open();
          return w.document.location = canvas.toDataURL();
        },
        undoable: false
      });
      canvas.addAction({
        name: "load",
        perform: function(canvas) {
          var sha, url;
          if (sha = prompt("SHA")) {
            url = Resource.url(sha, true);
            return canvas.fromDataURL(url);
          }
        }
      });
      return canvas.addAction({
        name: "save",
        perform: function(canvas) {
          var data, raw, sha;
          data = canvas.toBase64();
          $.post('/upload', {
            data_base64: data,
            type: "image/png"
          });
          raw = CryptoJS.enc.Base64.parse(data);
          sha = CryptoJS.SHA1(raw).toString();
          displaySaved(sha, data);
          appData.push(sha);
          return localStorage.pixieData = JSON.stringify(appData);
        },
        undoable: false
      });
    }
  });
  return pixelEditor.appendTo($('body'));
});
