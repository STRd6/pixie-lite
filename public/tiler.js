// Generated by CoffeeScript 1.4.0
var Map, Tiler, tiler;

Map = function() {
  var canvas, canvasElement, context, drawTile, height, layers, parseLayer, tileHeight, tileWidth, width;
  tileWidth = 64;
  tileHeight = 32;
  width = 640;
  height = 480;
  canvas = $("<canvas width=" + width + " height=" + height + ">").css({
    display: "block"
  }).appendTo("body");
  canvasElement = canvas.get(0);
  context = canvasElement.getContext("2d");
  parseLayer = function(text) {
    return text.split("\n").map(function(row) {
      return row.split('').map(function(n) {
        var res;
        res = parseInt(n, 10);
        if (res !== 0) {
          return res || void 0;
        } else {
          return res;
        }
      });
    });
  };
  layers = ["0000\n0000\n0000\n0000", "3  3\n\n\n3  3"].map(parseLayer);
  console.log(layers);
  drawTile = function(tile, x, y) {
    var img;
    img = $("img").get(tile);
    return context.drawImage(img, x, y + height / 2);
  };
  return {
    render: function() {
      return layers.each(function(layer, z) {
        return layer.length.times(function(i) {
          var row, size;
          row = layer[i];
          size = row.length;
          return size.times(function(j) {
            var tile, x, y;
            j = (size - 1) - j;
            tile = row[j];
            x = (j * tileWidth / 2) + (i * tileWidth / 2);
            y = (i * tileHeight / 2) - (j * tileHeight / 2);
            if (tile != null) {
              return drawTile(tile, x, y - (tileHeight * z));
            }
          });
        });
      });
    }
  };
};

Tiler = function() {
  var page, perPage, render, tileShas;
  tileShas = Storage.list("tiles");
  perPage = 113;
  page = 0;
  console.log(tileShas);
  render = function() {
    var n;
    $("#tiles").empty();
    n = perPage * page;
    return tileShas.slice(n, n + perPage).each(function(sha) {
      var img, url;
      url = Resource.url(sha);
      return img = $("<img>", {
        src: url
      }).appendTo("#tiles");
    });
  };
  render();
  return {
    changePage: function(delta) {
      page += delta;
      return render();
    }
  };
};

window.Tiler = Tiler;

$("<div id='tiles'>").appendTo("body");

tiler = Tiler();

setTimeout(function() {
  return Map().render();
}, 1000);

$(document).bind("keydown", "=", function() {
  return tiler.changePage(+1);
});

$(document).bind("keydown", "-", function() {
  return tiler.changePage(-1);
});
